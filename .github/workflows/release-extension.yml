name: Release Extension

on:
  push:
    tags:
      - "extension-v*"
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag (e.g. extension-v1.0.0)"
        required: false
        type: string
      create_github_release:
        description: "Create GitHub release with extension zip"
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build-package:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/extension
    outputs:
      version: ${{ steps.meta.outputs.version }}
      zip_name: ${{ steps.meta.outputs.zip_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run type check
        run: bun run typecheck

      - name: Build production extension bundle
        run: bun run build:prod

      - name: Package production extension zip
        run: bun run package:prod

      - name: Collect release metadata
        id: meta
        run: |
          VERSION=$(node -p "JSON.parse(require('fs').readFileSync('./package.json', 'utf8')).version")
          ZIP_NAME="nod-extension-v${VERSION}.zip"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload packaged extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.zip_name }}
          path: apps/extension/dist/release/${{ steps.meta.outputs.zip_name }}
          if-no-files-found: error
          retention-days: 14

  publish-release:
    needs: build-package
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.create_github_release) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${{ inputs.release_tag }}"
          fi

          if [ -z "$TAG" ]; then
            echo "release_tag input is required for manual release." >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Create tag when missing (manual run)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" "$GITHUB_SHA"
          git push origin "$TAG"

      - name: Download packaged extension artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-package.outputs.zip_name }}
          path: dist/release

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Extension v${{ needs.build-package.outputs.version }}
          files: dist/release/${{ needs.build-package.outputs.zip_name }}
          generate_release_notes: true
